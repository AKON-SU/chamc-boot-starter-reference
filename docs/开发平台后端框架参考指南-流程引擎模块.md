# 流程引擎——第一个流程

- 步骤概述：

> [Step 1：在管理页面设计流程图（包括流程参与人、操作等的配置）](#bpm_3_1)  
> [Step 2：在开发项目中引入`starter-bpm`模块](#bpm_3_2)  
> [Step 3：项目中的流程配置](#bpm_3_3)  
> [Step 4：流程发起及操作](#bpm_3_4)

- Step 1：<span id="bpm_3_1">在管理页面设计流程图（包括流程参与人、操作等的配置）</span>

1）访问并登录**流程引擎后台管理平台**，登录后主页面及导航栏如图process-1所示，`系统设置`的子菜单可以管理用户、机构和角色等，可以分别点击进行对应的操作。为了方便使用，系统初始已预置初始数据，可查看确认。

![图 process-1：系统设置](https://i.imgur.com/ls4so0u.jpg)

<center>图 process-1：系统设置</center>

2）点击`工作流管理`-`流程创建管理`，如图process-2所示，进入流程设计管理页面，在该页面可以完成流程的新建、发布等。

![图 process-2：流程设计界面](https://i.imgur.com/2iqIYgv.png)

<center>图 process-2：流程设计界面</center>

3）点击新建流程，如图process-3所示，填写流程定义信息（所属租户，流程key等），填写完成后，点击确认保存流程定义信息。再次点击主页面的导航栏`工作流管理`-`流程创建管理`,可以看到列表第一条数据为刚才新建的流程，点击编辑操作，进入流程设计界面，如图process-4所示。

![图 process-3：新建流程](https://i.imgur.com/WoDqP2d.png)

<center>图 process-3：新建流程</center>

![图 process-4：进入流程设计界面](https://i.imgur.com/2xZUH6z.png)

<center>图 process-4：进入流程设计界面</center>

4）设计流程图，在demo示例中设计简单的流程（启动-制单-领导审批-结束）。点击左侧`启动事件`，将`事件`控件拖入页面中间设计区域，如图process-5所示；点击拖入的`事件`，周围显示可以连接的其他控件，点击`分配给特定人的任务`，如图process-6所示，添加一个新的activity；按照同样的步骤，点击刚新建的activity，在周围出现的选项中点击`分配给特定人的任务`，添加第二个activity；同理点击第二个activity，选择红色的圈（一个无触发器的结束任务），添加结束节点。

![图 process-5：拖入启动事件](https://i.imgur.com/5Nn8DQ3.png)

<center>图 process-5：拖入启动事件</center>

![图 process-6：添加activity](https://i.imgur.com/Qlx6Iyv.png)

<center>图 process-6：添加activity</center>

5）配置activity。如图process-7所示，点击后可以在右侧菜单设置activity属性，点击创建的第一个activity，输入id、名称，点击代理后的输入框，选择参与人信息，如图process-8所示，确认后点击任务节点功能，配置对于该activity的功能操作，勾选下一步操作，保存确认后，点击流程设计页面中控件栏上方的保存按钮，并关闭该页面，如图process-9所示。

![图 process-7：修改属性](https://i.imgur.com/Ixi3we6.png)

<center>图 process-7：修改属性</center>

![图 process-8：设置参与人](https://i.imgur.com/3iyabyT.png)

<center>图 process-8：设置参与人</center>

![图 process-9：保存](https://i.imgur.com/91F6Xfp.png)

<center>图 process-9：保存</center>

6）发布流程图，再次点击主页面的导航栏`工作流管理`-`流程创建管理`，找到刚编辑的流程定义的条目并点击发布，提示流程发布成功，即完成了流程的设计与发布过程。

- Step 2：<span id="bpm_3_2">在开发项目中引入`bpm`模块</span>

1） 集成方式

流程引擎以jar工具包的形式提供服务，以下示例maven项目的集成：

2）：下载文件

到私服[http://10.80.38.200:8081/#browse/browse/components:maven-snapshots](http://10.80.38.200:8081/#browse/browse/components:maven-snapshots)下载，将`chamc-boot-starter-parent`、`chamc-boot-starter-bpm`文件夹下载到本地。

3）：把jar包安装到maven仓库

打开本地maven仓库，在Preferences —》Maven —》User Settings 中查看本地仓库的目录，如“图 maven setting”所示的C:\Users\tanghongshi\.m2\repository。分别查看`chamc-boot-starter-parent`、`chamc-boot-starter-bpm`两个文件夹下的pom文件，在maven仓库中按照`com -> chamc -> boot -> *` 的路径创建文件夹。*为pom文件中的artifactId描述。如“图 pom文件”所示为“chamc-boot-starter-bpm”，然后将上一步下载的文件拷贝到对应目录下。

![](https://i.imgur.com/blBvUrj.png)
<center>图 maven setting</center>

![pom文件](https://i.imgur.com/beJ4Cgz.jpg)
<center>图 pom 文件</center>

4）**：项目依赖添加

根据第一步下载的文件夹中的pom文件描述，可以获取到依赖包的artifactId和version，在pom文件的`<dependencies></dependencies>`中添加信息，如下所述，groupId为`com.chamc.boot`.

	<dependency>
		<groupId>com.chamc.boot</groupId>
		<artifactId>chamc-boot-starter-bpm</artifactId>
		<version>0.0.1-SNAPSHOT</version>
	</dependency>

5）：在工程目录上右键，选择 `Maven` -> `Update Project` -> `OK`，项目自动编译后，如果没有异常，就能够使用流程服务了。


- Step 3：<span id="bpm_3_3">项目中的流程配置</span>

以SpringBoot项目为例：

1）在配置文件（application.properties）中添加如下所示的内容：

    chamc.bpm.type=tansun
    chamc.bpm.tansun.url=http://localhost:8080/workflow-console #流程引擎服务地址
    chamc.bpm.tansun.tenant-id=archive  #租户ID，可以在“流程引擎后台管理平台——工作流管理——租户管理”查看
    chamc.bpm.tansun.default-classify-code=root #流程分配编码

- Step 4：<span id="bpm_3_4">流程发起及操作</span>

1）发起流程

在SpringBoot项目需要的地方注入`com.chamc.boot.bpm.service.IInstanceService`，调用iInstanceService.startBpm(startBpmParam)即可启动流程，示例：

    import org.springframework.beans.factory.annotation.Autowired;

    import com.chamc.boot.bpm.model.process.param.StartBpmParam;
    import com.chamc.boot.bpm.service.IInstanceService;

    public class InstanceServiceDemo {

    	private @Autowired IInstanceService iInstanceService;
    
    	public void startBpm() {
    		StartBpmParam startBpmParam = new StartBpmParam();
    		startBpmParam.setProcessKey("process-helloworld");
    		startBpmParam.setUserId("user1");
    		startBpmParam.setTitle("测试任务标题");
    		iInstanceService.startBpm(startBpmParam);
    	}
    }

2）查看待办**/**已办任务

注入`com.chamc.boot.bpm.service.ITaskService`，调用iTaskService.queryTodo(userId, pageable)方法查看待办任务列表，根据[流程定义信息](#bpm_3_1)，此时第一个activity配置的参与人应收到一条待办任务。或者通过queryDone接口查看已办任务列表，如下所示：

    import org.springframework.beans.factory.annotation.Autowired;
    import org.springframework.data.domain.Page;
    import org.springframework.data.domain.PageRequest;
    import org.springframework.data.domain.Pageable;
    
    import com.chamc.boot.bpm.model.task.TaskDone;
    import com.chamc.boot.bpm.model.task.TaskTodo;
    import com.chamc.boot.bpm.service.ITaskService;
    
    public class TaskServiceDemo {
    
    	private @Autowired ITaskService iTaskService;
    	
    	public Page<TaskTodo> queryTaskTodo(String userId) {
    		Pageable pageable = new PageRequest(0, 20);		//构造pageable对象，查询第1页数据，分页大小为20
    		Page<TaskTodo> todoPage = iTaskService.queryTodo(userId, pageable);
    		return todoPage;
    	}
    	
    	public Page<TaskDone> queryTaskDone(String userId) {
    		Pageable pageable = new PageRequest(0, 20);
    		Page<TaskDone> donePage = iTaskService.queryDone(userId, pageable);
    		return donePage;
    	}
    }

待办任务TaskTodo列表如下所示，包含分页信息及待办任务列表，对每个待办任务，包含该任务当前所处的环节、基本信息、可进行的操作和流程实例信息等，其中基本信息中的`pcUrl`和`mobileUrl`分别对应pc段和移动端的任务详情页，该地址可以通过配置文件配置。获取待办列表后直接访问待办的pcUrl/mobileUrl即可进入任务的详情页面。

在任务详情页对待办任务进行操作，操作的按钮可以从待办任务的operations中获取，operations为对象数组，Operation返回值对象，包含信息较多：1、返回对应activity可进行的操作、操作名称及url；2、通过isNeedUserId标识该操作是否需要传用户id；3、通过isPlural标识需要用户id的话，是传1个还是多个；4、如果传的用户id（即下一个activity要用的用户id）有限定范围，那么会通过userRange返回给用户。operation对象示例可参考[Operation](#Operation)。

对于前端使用来说，点击按钮时，取值Operation中的url，并按照Operation的要求附加参数，使用示例参考[actionTask](#actionTask)，

	{
	  "content": [
	    {
	      "activity": {
	        "first": true,
	        "id": "string",
	        "last": true,
	        "name": "string"
	      },
	      "createTime": "2017-12-18T05:23:44.730Z",
	      "dueDate": "2017-12-18T05:23:44.730Z",
	      "executionId": "string",
	      "id": "string",
	      "mobileUrl": "string",
	      "name": "string",
	      "operations": [
	        {
	          "needUserId": true,
	          "op": "同意",
	          "plural": true,
	          "text": "string",
	          "url": "string",
	          "userRange": [
	            "string"
	          ]
	        }
	      ],
	      "pcUrl": "string",
	      "processInstance": {
	        "businessKey": "string",
	        "currentActivity": {
	          "first": true,
	          "id": "string",
	          "last": true,
	          "name": "string"
	        },
	        "definitionId": "string",
	        "definitionName": "string",
	        "id": "string",
	        "startParticipant": {
	          "code": "string",
	          "id": "string",
	          "name": "string",
	          "org": "string",
	          "orgName": "string",
	          "type": "USER"
	        },
	        "title": "string"
	      }
	    }
	  ],
	  "first": true,
	  "last": true,
	  "number": 0,
	  "numberOfElements": 0,
	  "size": 0,
	  "sort": {},
	  "totalElements": 0,
	  "totalPages": 0
	}

<span id="actionTask">前端任务操作示例：actionTask</span>

	function actionTask(instanceId, taskId, url, needUserId, plural) {
		if(needUserId) {
			//弹框选人
		}
		var params = {};
		params.instanceId = instanceId;
		params.taskId = taskId;
		params.operatorId = "";
		params.comment = $("#task_comment").val();
		params.variables = {};
		if(needUserId) {
			//添加用户变量，多个用逗号隔开
			params.userId = "default_user_id";
		}
		$.post(url, params, function(result) {
			if("OK" == result) {
				document.location = "http://localhost:8000/zouzhentian@chamc.com.cn@8499/todo";
			} else {
				alert(result);
			}
		});
	}

3）处理任务

`bpm`模块提供了任务的基本操作服务，直接访问请求即可。在第一个流程中，我们通过这种方式操作任务，例如启动应用后，根据应用部署的ip:port，直接访问{http://ip:port}/bpm/task/agree，就能完成该任务的同意操作。  
操作和驳回的请求路径及部分参数说明如下所示，完整说明信息请参考[3.3.6 BPM模块基本请求](#bpm_6)。

简单示例：

同意审批：访问post请求`{http://ip:port}/bpm/task/agree?` + `operatorId=用户id` + `&taskId=任务id` + `&comment=审批意见`

驳回上一步：访问post请求`{http://ip:port}/bpm/task/reject?` + `operatorId=用户id` + `&taskId=任务id` + `&comment=驳回意见`

4）查看流转明细

    private @Autowired IInstanceService iInstanceService;

	public List<ProcessTransferDetail> queryTransferDetail(String instanceId) {
		List<ProcessTransferDetail> result = iInstanceService.queryTransferDetail(instanceId);
		return result;
	}

至此，已经完成了第一个流程demo。包括流程设计、流程发起、待办已办查询、任务处理及查询流转明细等。

至此，已经完成了第一个完整的流程。包括流程设计、流程发起、待办已办查询、任务处理及查询流转明细等。
我们把很多底层接口都已经封装到了流程引擎设计器中，所以，1.0版本对外只提供4个核心接口供业务系统，尽量减少业务系统的集成复杂度。

>**附注：**

>技术支持，电话：15372585154， 邮件：[luomingqiang@chamc.com.cn](mailto:luomingqiang@chamc.com.cn);

>流程设计器试用地址：[http://10.1.8.117:8080/workflow-console](http://10.1.8.117:8080/workflow-console)，账号：请与我们联系申请；